#!/bin/bash

# =============================
# READ EMV
# =============================

if [[ ! -f "./env" ]]
then
  echo "./env file missing"
  exit 1
fi

. ./env

# =============================
# CONSTANTS
# =============================

DEFAULT_INSTANCE_COUNT=2
DEFAULT_REMOVE=Y

# =============================
# FUNCTION
# =============================

usage () {
  echo "$1 usage: [-INSTANCE_COUNT <number <=10 >] [ -REMOVE (Y|N) ] - defaults -INSTANCE_COUNT ${DEFAULT_INSTANCE_COUNT} -REMOVE ${DEFAULT_REMOVE} "
}

instance_count () {
  FLAG="`echo "$2" | grep '^[0][0123456789]*$' | wc -l | awk '{ print $1 }'`"

  if [[ "${FLAG}" == "1" ]]
  then
    usage "error: invalid INSTANCE_COUNT value '$2'"
    exit 1
  fi

  FLAG="`echo "$2" | grep '^[0123456789]*$' | wc -l | awk '{ print $1 }'`"

  if [[ "${FLAG}" == "1" ]]
  then
    if [[ $2 -eq -0 ]]
    then
      usage "error: invalid INSTANCE_COUNT value '$2'"
      exit 1
    fi
    INSTANCE_COUNT=$2
  else
    usage "error: invalid INSTANCE_COUNT value '$2'"
    exit 1
  fi
}

remove() {
  if [[ "$1" != "-REMOVE" ]]
  then
    usage "error: invalid argument '$1'."
    exit 1
  fi

  if [[ "$2" != "N" && "$2" != "Y" ]]
  then
    usage "error: invalid argument '$2'."
    exit 1
  fi

  REMOVE="$2"
}

# =============================
# PREAMBLE
# =============================

if [[ "${OSTYPE}" != "linux-gnu"* && "${OSTYPE}" != "darwin"* ]]
then
  echo "error: only linux and macOS supported"
  exit 1
fi

if [[ "$#" != "0" && "$#" != "2" && "$#" != "4" ]]
then
  usage "error: invalid arguments."
  exit 1
fi

INSTANCE_COUNT=
REMOVE=

if [[ "$1" == "-INSTANCE_COUNT" ]]
then
  instance_count "$1" "$2"

  if [[ "$#" == "4" ]]
  then
    remove "$3" "$4"
  else
    REMOVE=${DEFAULT_REMOVE}
  fi

elif [[ "$1" == "-REMOVE" ]]
then
  remove "$1" "$2"

  INSTANCE_COUNT=2
else
  if [[ "$#" != "0" ]]
  then
    usage "error: invalid parameters"
    exit 1
  fi

  INSTANCE_COUNT=2
  REMOVE=${DEFAULT_REMOVE}
fi

echo "INSTANCE_COUNT='${INSTANCE_COUNT}'"
echo "REMOVE='${REMOVE}'"

if [[ ${INSTANCE_COUNT} -gt "10" ]]
then
  usage "INSTANCE_COUNT is > 10."
  exit 1
fi

X=1

while [[ $X -le $INSTANCE_COUNT ]]
do
  TAG_ID_INSTANCE="${TAG_ID}_${X}"
  echo "TAG_ID_INSTANCE=${TAG_ID_INSTANCE}"

  let X=$((X + 1))
done
